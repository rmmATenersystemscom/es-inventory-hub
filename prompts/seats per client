#API Enhancement: Seat Counts by Client

## Overview
Need to create a new API endpoint (or enhance existing one) to provide seat count data broken down by **client** and **month**, instead of just monthly totals.

## Current State
The existing QBR API endpoint `/api/qbr/metrics/monthly` returns aggregated monthly metrics:

**Current Endpoint:**
```
GET /api/qbr/metrics/monthly?period=YYYY-MM&organization_id=1
```

**Current Response Format:**
```json
{
  "success": true,
  "data": {
    "metrics": [
      {
        "metric_name": "seats_managed",
        "metric_value": 450
      },
      {
        "metric_name": "reactive_tickets_created",
        "metric_value": 125
      }
    ]
  }
}
```

**Problem:** The `seats_managed` metric is only a monthly total. We need it broken down by client.

## Required Change

### Option 1: Create New Endpoint (Recommended)
Create a new endpoint that returns seat counts by client for a given time period:

**New Endpoint:**
```
GET /api/qbr/metrics/seats-by-client
```

**Query Parameters:**
- `period` (required): Month in format `YYYY-MM` (e.g., "2025-01")
- `organization_id` (required): Organization ID (e.g., 1)

**Required Response Format:**
```json
{
  "success": true,
  "data": {
    "period": "2025-01",
    "organization_id": 1,
    "clients": [
      {
        "client_id": 123,
        "client_name": "Acme Corporation",
        "seats_managed": 45
      },
      {
        "client_id": 124,
        "client_name": "Widget Industries",
        "seats_managed": 32
      },
      {
        "client_id": 125,
        "client_name": "TechStart LLC",
        "seats_managed": 18
      }
    ],
    "total_seats": 95
  }
}
```

### Option 2: Enhance Existing Endpoint (Alternative)
Add an optional parameter to the existing endpoint:

**Enhanced Endpoint:**
```
GET /api/qbr/metrics/monthly?period=YYYY-MM&organization_id=1&breakdown=client
```

When `breakdown=client` is provided, return per-client data for metrics that support it:

**Enhanced Response Format:**
```json
{
  "success": true,
  "data": {
    "metrics": [
      {
        "metric_name": "seats_managed",
        "metric_value": 450,
        "by_client": [
          {"client_id": 123, "client_name": "Acme Corporation", "value": 45},
          {"client_id": 124, "client_name": "Widget Industries", "value": 32}
        ]
      }
    ]
  }
}
```

## Data Source
The seat count data should come from the same source currently used to calculate the monthly `seats_managed` total. This is likely:
- **NinjaRMM API** device counts per organization
- Filtered to exclude servers, VMs, spares, and specific organizations
- Grouped by client/organization name

The same logic used in the tickets-per-client-per-month dashboard can be referenced:
- Location: `/opt/dashboard-project/es-dashboards/dashboards/tickets-per-client-per-month/connectwise_api.py`
- Function: `get_seat_counts_by_organization()` (lines 421-446)

## Requirements

1. **Authentication**: Must use the same Microsoft OAuth authentication as existing QBR endpoints
2. **Performance**: Should handle requests for any month from 2024-present
3. **Caching**: Consider caching results since historical data doesn't change
4. **Error Handling**: Return appropriate error codes:
   - `401`: Unauthorized (not authenticated)
   - `400`: Bad request (invalid period format)
   - `404`: No data found for period
   - `500`: Internal server error

## Example Usage

Once implemented, the QBR dashboard will call this endpoint to get per-client seat counts:

```javascript
// Fetch seat counts by client for January 2025
const response = await fetch(
    'https://db-api.enersystems.com:5400/api/qbr/metrics/seats-by-client?period=2025-01&organization_id=1',
    { credentials: 'include' }
);

const data = await response.json();
// data.data.clients = [{client_name: "...", seats_managed: 45}, ...]
```

## Testing

After implementation, test with:
1. Current month (should return live data)
2. Previous month (should return historical data)
3. Invalid period format (should return 400 error)
4. Unauthenticated request (should return 401 error)

## Questions?

If the data source for seat counts is unclear or if there's a different preferred approach, please provide:
1. Database schema/tables where seat count data is stored
2. How historical seat counts are tracked (if at all)
3. Whether seat counts should be calculated on-demand or retrieved from stored data

---

**Version**: v3.69.0
**Last Updated**: November 22, 2025 12:35 UTC
**Maintainer**: ES Dashboards Team
